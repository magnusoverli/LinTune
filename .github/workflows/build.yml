name: Build LinTune Executable

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xfixes0 \
          libgl1-mesa-glx \
          libegl1 \
          libdbus-1-3 \
          libfontconfig1 \
          libfreetype6
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --onefile \
          --name LinTune \
          --windowed \
          --add-data "src/lintune/resources:lintune/resources" \
          --hidden-import PyQt6 \
          --hidden-import PyQt6.QtCore \
          --hidden-import PyQt6.QtGui \
          --hidden-import PyQt6.QtWidgets \
          --hidden-import distro \
          --hidden-import psutil \
          --hidden-import jinja2 \
          --collect-all PyQt6 \
          src/lintune/__main__.py
    
    - name: Make executable runnable
      run: chmod +x dist/LinTune
    
    - name: Create AppImage structure (optional)
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp dist/LinTune AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/usr/share/applications/lintune.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=LinTune
        Comment=EntraID & Intune Setup for Linux
        Exec=LinTune
        Icon=lintune
        Categories=System;Settings;
        Terminal=false
        EOF
        
        # Create a simple icon placeholder (you can replace with actual icon)
        echo "Icon file would go here" > AppDir/usr/share/icons/hicolor/256x256/apps/lintune.png
    
    - name: Package as tarball
      run: |
        cd dist
        tar -czf LinTune-linux-x64.tar.gz LinTune
        cd ..
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LinTune-linux-x64
        path: |
          dist/LinTune
          dist/LinTune-linux-x64.tar.gz
        retention-days: 90
    
    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/LinTune-linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
